<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>DG Meter Camera</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
</head>
<body style="font-family: Arial; text-align:center; padding:20px;">

  <h2>DG Meter Photo Capture</h2>

  <label>Block:</label><br>
  <select id="block" style="font-size:18px; padding:5px;">
    <option value="">Select Block</option>
    <option>A</option><option>B</option><option>C</option>
    <option>D</option><option>E</option><option>F</option><option>G</option>
  </select>

  <br><br>

  <label>Villa Number:</label><br>
  <select id="villaNum" style="font-size:18px; padding:5px;">
    <option value="">Select Villa</option>
  </select>

  <br><br>

  <video id="camera" width="300" autoplay playsinline></video><br><br>

  <button onclick="takePhoto()" style="font-size:18px; padding:10px 20px;">
    ⚡ Capture DG Meter
  </button>

  <p id="status"></p>
  <canvas id="canvas" style="display:none;"></canvas>

  <script>
document.addEventListener("DOMContentLoaded", function () {

  const video = document.getElementById('camera');
  const status = document.getElementById('status');

  // Start camera
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => video.srcObject = stream)
    .catch(() => {
      status.innerText = "Camera access denied or not supported.";
    });

  // Populate villa numbers 1–14
  const villaSelect = document.getElementById('villaNum');
  for (let i = 1; i <= 14; i++) {
    const option = document.createElement('option');
    option.value = i;
    option.text = i;
    villaSelect.appendChild(option);
  }

  window.takePhoto = function () {
    const block = document.getElementById('block').value;
    const villaNum = document.getElementById('villaNum').value;

    if (!block || !villaNum) {
      status.innerText = "Select Block and Villa Number first.";
      return;
    }

    const villa = block + villaNum;

    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);

    canvas.toBlob(blob => {
      const fileName = `DG_${villa}_DG.jpg`;

      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = fileName;
      link.click();

      status.innerText = `Saved: ${fileName}`;
    }, 'image/jpeg', 0.95);
  };

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
  }

});
</script>
